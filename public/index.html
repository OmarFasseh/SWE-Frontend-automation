<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />

    <link rel="icon" href="%PUBLIC_URL%/spotify.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="Web site created using create-react-app"
    />
    <meta HTTP-EQUIV="Pragma" CONTENT="no-cache">
    <meta HTTP-EQUIV="Expires" CONTENT="-1">
   
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossOrigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <title>Spotify</title>
  </head>
  <body id="mybody">
    <noscript>You need to enable JavaScript to run this app.</noscript>
  
    

    <script>
      window.fbAsyncInit = function() {
        FB.init({
          appId            : '2542629655959579',
          autoLogAppEvents : true,
          xfbml            : true,
          version          : 'v6.0'
        });
      };
    </script>
    <script async defer src="https://connect.facebook.net/en_US/sdk.js"></script>
    <script>
      (function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) { return; }
        js = d.createElement(s); js.id = id;
        js.src = "https://connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
      }(document, 'script', 'facebook-jssdk'));
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossOrigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossOrigin="anonymous"></script>



    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

    <script src="https://www.gstatic.com/firebasejs/3.5.0/firebase-app.js"></script>                    
    <script src="https://www.gstatic.com/firebasejs/3.5.0/firebase-messaging.js"></script>              
    <script>                                                                                            
                                                                        
  var config = {
  apiKey: "AIzaSyDstl21Iann4t-odVPIMFTXpI5ToD1jIC0",
  authDomain: "totally-not-spotify.firebaseapp.com",
  databaseURL: "https://totally-not-spotify.firebaseio.com",
  projectId: "totally-not-spotify",
  storageBucket: "totally-not-spotify.appspot.com",
  messagingSenderId: "262598048193",
  appId: "1:262598048193:web:8eb027331acfe77f625740",
  measurementId: "G-YDVW3R60NT"
};

firebase.initializeApp(config);

const messaging = firebase.messaging();
// Add the public key generated from the console here.
//messaging.usePublicVapidKey("BKWMGFcg3yIaZ8ONAeIORVydRfg1GFtMnKcCPV-jFyEXWAlbLv8nv9Wtsr4Gu5NsVHZTFl4yD0ZXcZpqsBvrIj8");
messaging.requestPermission()
  .then (function(){
    console.log("Have permission");
    return messaging.getToken();
  })
  .then(function(token){
  //  messaging.updateUIForPushEnabled(token);
  //messaging.sendSubscriptionToServer(token);
       updateUIForPushEnabled(token);
      sendSubscriptionToServer(token);
  console.log("token is "); 
  console.log(token);
         axios.put("https://totallynotspotify.codes/api/me/notifications/token",
          {
            "token":token,
            "type":"web"
            },
             {
            headers: {
              authorization: "Bearer " + localStorage.getItem("token"),
            },
          })
          .then(res => {
            console.log(res)
         if(res.status===204){
            console.log("Request Succesful and token is ", token)
        }
      })
      .catch(res => {
        console.log(res)
      })
  })
.catch(function(err){
  alert(err);
})    

messaging.onMessage(function(payload) {
  console.log("got message")
  const notificationTitle = payload.notification.title;
  const notificationOptions = {
      body: payload.notification.body,
      icon: payload.notification.icon,        
  };
  if (!("Notification" in window)) {
    console.log("This browser does not support system notifications");
}
// Let's check whether notification permissions have already been granted
else if (Notification.permission === "granted") {
    // If it's okay let's create a notification
    var notification = new Notification(notificationTitle,notificationOptions);
    notification.onclick = function(event) {
        event.preventDefault(); // prevent the browser from focusing the Notification's tab
        window.open(payload.notification.click_action , '_blank');
        notification.close();
    }
}
});

self.addEventListener('notificationclick', function(event) {
  console.log('[firebase-messaging-sw.js] Received notificationclick event ', event);
  
  var click_action = event.notification.data;
  event.notification.close();
  // This looks to see if the current is already open and
  // focuses if it is
  event.waitUntil(clients.matchAll({
      type: "window"
  }).then(function(clientList) {
      for (var i = 0; i < clientList.length; i++) {
          var client = clientList[i];
          if (client.url == click_action  && 'focus' in client)
              return client.focus();
      }
      if (clients.openWindow)
          return clients.openWindow(click_action);
      }));
  
  });
  const showMessage = function(payload){
      console.log('showMessage', payload);
      const notificationTitle = payload.data.title;
      const notificationOptions = {
          body: payload.data.body,
          icon: payload.data.icon,
          image: payload.data.image,
          click_action: payload.data.click_action,
          data:payload.data.click_action
      };  
  
  
     self.registration.showNotification(notificationTitle,notificationOptions); 
  }   
  messaging.setBackgroundMessageHandler(showMessage);
  
  self.addEventListener('message', function (evt) {     
    console.log("self",self);
    showMessage( evt.data );
  })
  
  
      </script>           




  </body>
</html>
